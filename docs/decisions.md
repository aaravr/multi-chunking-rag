Decisions Log

2026-02-02: Added heading_path and section_id to chunks to support deterministic section lineage (SPEC_ADDENDUM A2). Implemented deterministic heading heuristics in canonicalization and persisted fields in storage schema. This keeps embeddings unchanged and preserves SoC while enabling later section-based retrieval.
2026-02-02: Added table atomicity handling by detecting DI/native tables during canonicalization and storing each table as a single Markdown chunk with table-level polygons and heading breadcrumb. This avoids cell-level semantics while preserving table integrity (SPEC_ADDENDUM A3).
2026-02-02: Added intent-aware retrieval routing (location/coverage/semantic). Location queries filter by page_numbers before scoring; coverage queries expand by heading_path/section_id. Default semantic retrieval remains top-K vector search (SPEC_ADDENDUM A1).
2026-02-02: Implemented optional hybrid retrieval (BM25 + vector fused via RRF) and an optional verifier (LLM audit YES/NO). Both are opt-in via config to preserve default behavior (SPEC_ADDENDUM A4).
2026-02-02: Added optional cross-encoder reranking with cross-encoder/ms-marco-MiniLM-L-6-v2 on CPU. Trade-off: improves ranking quality on targeted queries at added latency; kept feature-flagged to preserve default performance (SPEC_ADDENDUM A4).
2026-02-02: CoverageQuery retrieval now uses anchor search with query expansions and deterministic scope expansion by heading_path/section_id, falling back to a page-window expansion when section metadata is missing. Coverage synthesis is deterministic and citation-first to keep list answers grounded; verifier checks each listed item against cited chunks and returns searched sections/pages when none found (SPEC_ADDENDUM A1).
2026-02-02: CoverageQuery uses deterministic-first extraction with a guarded LLM fallback when fewer than the minimum list items are found. This avoids empty lists due to parsing noise while keeping citations attached to retrieved chunks. Coverage verifier normalizes item and chunk text (lowercase, alphanumerics only, collapsed whitespace) and requires >=70% token coverage, logging missing tokens on failure.
2026-02-02: CoverageQuery exposes explicit mode control (deterministic, llm_fallback, llm_always). Default is llm_fallback to preserve deterministic grounding when possible while providing resilience against pattern mismatches. llm_always is available for maximum recall but keeps citations and verifier checks.
2026-02-04: Added fail-fast schema contract checks at app startup and before ingestion to prevent wasted processing when migrations are missing (SPEC §7, §11).
2026-02-04: Context: Coverage queries were expanding from arbitrary semantic results and “items of note” anchored on financial statement tables. Decision: introduce retrieval plan abstraction (locate → expand → select), enforce section-read ordering, and apply table-aware filtering for MD&A-style queries with explicit items-of-note anchor rules. Consequences: coverage queries always anchor + read full section in order, and table anchors are blocked unless explicitly requested. Alternatives considered: rely on top-K semantic results; rejected due to repeated mis-anchoring.
2026-02-04: Context: CoverageQuery now supports list/attribute/numeric_list/pointer subtypes with status_filter for closed matters. Decision: classify subtypes at intent time and route to subtype-appropriate synthesis/verification. Consequences: numeric list and pointer queries no longer use litigation list logic; coverage attributes remain LLM-first with numeric span verification. Alternatives considered: single coverage path with heuristic prompts; rejected for ambiguity.
2026-02-08: Context: Document-level metadata queries were repeatedly re-parsed from full documents and lacked deterministic caching. Decision: add document_facts cache with explicit evidence lineage and a front-matter fallback when cache is disabled or missing. Consequences: faster, citation-backed metadata retrieval without inference, and explicit not_found/ambiguous states. Alternatives considered: always re-run full retrieval; rejected due to cost and inconsistency.
2026-02-08: Context: Presentation currency often appears after the first few pages in Basis of presentation or accounting policies. Decision: expand metadata locate to pages 1–10 plus first occurrences of specific headings and BM25 keyword search over narrative chunks, while excluding tables. Consequences: improved recall without weakening evidence rules; no inference from transactional tables. Alternatives considered: scan full document; rejected for cost.
2026-02-08: Context: Items-of-note anchors sometimes matched front-matter headers without any enumerated items. Decision: require numeric token or list marker in the anchor candidate; otherwise continue searching later MD&A sections. Consequences: reduces false anchors and prefers content with actual itemization. Alternatives considered: accept earliest heading match; rejected due to false positives.
2026-02-09: Context: Items-of-note numeric list queries anchored on adjusted-measures ratio definitions and glossary references. Decision: reject adjusted-measures definitions and front-matter references, require reconciliation signals plus itemization or aggregate impact for numeric_list anchors. Consequences: prevents false anchors and keeps MD&A reconciliation as the anchor source with explicit debug reasons. Alternatives considered: relax acceptance for recall; rejected due to repeated mis-anchoring.
2026-02-09: Context: Items-of-note anchors sometimes reference reconciliation without listing items or aggregate impact. Decision: treat reconciliation-only references as meta and reject with explicit reason code. Consequences: avoids anchoring on guidance text and forces true itemization or aggregate impact in anchors. Alternatives considered: accept reconciliation references; rejected due to false anchors.
