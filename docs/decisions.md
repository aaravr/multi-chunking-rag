Decisions Log

2026-02-02: Added heading_path and section_id to chunks to support deterministic section lineage (SPEC_ADDENDUM A2). Implemented deterministic heading heuristics in canonicalization and persisted fields in storage schema. This keeps embeddings unchanged and preserves SoC while enabling later section-based retrieval.
2026-02-02: Added table atomicity handling by detecting DI/native tables during canonicalization and storing each table as a single Markdown chunk with table-level polygons and heading breadcrumb. This avoids cell-level semantics while preserving table integrity (SPEC_ADDENDUM A3).
2026-02-02: Added intent-aware retrieval routing (location/coverage/semantic). Location queries filter by page_numbers before scoring; coverage queries expand by heading_path/section_id. Default semantic retrieval remains top-K vector search (SPEC_ADDENDUM A1).
2026-02-02: Implemented optional hybrid retrieval (BM25 + vector fused via RRF) and an optional verifier (LLM audit YES/NO). Both are opt-in via config to preserve default behavior (SPEC_ADDENDUM A4).
2026-02-02: Added optional cross-encoder reranking with cross-encoder/ms-marco-MiniLM-L-6-v2 on CPU. Trade-off: improves ranking quality on targeted queries at added latency; kept feature-flagged to preserve default performance (SPEC_ADDENDUM A4).
2026-02-02: CoverageQuery retrieval now uses anchor search with query expansions and deterministic scope expansion by heading_path/section_id, falling back to a page-window expansion when section metadata is missing. Coverage synthesis is deterministic and citation-first to keep list answers grounded; verifier checks each listed item against cited chunks and returns searched sections/pages when none found (SPEC_ADDENDUM A1).
2026-02-02: CoverageQuery uses deterministic-first extraction with a guarded LLM fallback when fewer than the minimum list items are found. This avoids empty lists due to parsing noise while keeping citations attached to retrieved chunks. Coverage verifier normalizes item and chunk text (lowercase, alphanumerics only, collapsed whitespace) and requires >=70% token coverage, logging missing tokens on failure.
2026-02-02: CoverageQuery exposes explicit mode control (deterministic, llm_fallback, llm_always). Default is llm_fallback to preserve deterministic grounding when possible while providing resilience against pattern mismatches. llm_always is available for maximum recall but keeps citations and verifier checks.
2026-02-04: Added fail-fast schema contract checks at app startup and before ingestion to prevent wasted processing when migrations are missing (SPEC ยง7, ยง11).
